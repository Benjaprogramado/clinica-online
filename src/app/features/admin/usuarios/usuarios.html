<div class="usuarios-admin">
  <div class="header">
    <div class="header-title">
      <h1>Gestión de Usuarios</h1>
      <div class="acciones-header">
        <button class="btn-exportar" (click)="descargarUsuariosExcel()">
          <i class="pi pi-download"></i>
          Exportar Excel general
        </button>
        <button class="btn-nuevo-usuario" (click)="toggleFormulario()">
          <i class="pi pi-plus"></i>
          {{ mostrarFormulario() ? 'Cancelar' : 'Nuevo Usuario' }}
        </button>
      </div>
    </div>
    
    <div class="filtros">
      <div class="filtro-group filtro-rol">
        <label>Rol</label>
        <div class="botones">
          <button type="button" [class.activo]="filtroRol() === 'todos'" (click)="filtroRol.set('todos')">
            Todos
          </button>
          <button type="button" [class.activo]="filtroRol() === 'paciente'" (click)="filtroRol.set('paciente')">
            Pacientes
          </button>
          <button type="button" [class.activo]="filtroRol() === 'especialista'" (click)="filtroRol.set('especialista')">
            Especialistas
          </button>
          <button type="button" [class.activo]="filtroRol() === 'administrador'" (click)="filtroRol.set('administrador')">
            Administradores
          </button>
        </div>
      </div>
      
      <div class="filtro-group filtro-aprobacion">
        <label>Estado de aprobación</label>
        <div class="botones">
          <button type="button" [class.activo]="filtroAprobacion() === 'todos'" (click)="filtroAprobacion.set('todos')">
            Todos
          </button>
          <button type="button" [class.activo]="filtroAprobacion() === 'pendientes'" (click)="filtroAprobacion.set('pendientes')">
            Pendientes
          </button>
          <button type="button" [class.activo]="filtroAprobacion() === 'aprobados'" (click)="filtroAprobacion.set('aprobados')">
            Aprobados
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de nuevo usuario -->
  <div *ngIf="mostrarFormulario()">
    <app-form-usuario
      (usuarioCreado)="onUsuarioCreado()"
    ></app-form-usuario>
  </div>

  <div class="pendientes-section" *ngIf="getEspecialistasPendientes().length > 0">
    <h2>⚠️ Especialistas Pendientes de Aprobación ({{ getEspecialistasPendientes().length }})</h2>
    <div class="alert alert-warning">
      Hay especialistas que requieren aprobación antes de poder iniciar sesión.
    </div>
  </div>

  <div class="grid-usuarios" *ngIf="!cargando() && filtrarUsuarios().length > 0">
    @for (usuario of filtrarUsuarios(); track usuario.uid) {
      <article 
        class="usuario-card" 
        appHoverElevate 
        [class.inactivo]="!usuario.activo"
        [class.clickable]="usuario.role === 'paciente'"
        (click)="seleccionarUsuario(usuario)"
      >
        <header>
          <div class="identidad">
            <h2>{{ usuario | nombreCompleto }}</h2>
            <span class="email">{{ usuario.email || 'Sin email' }}</span>
          </div>
          <div class="badges">
            <span [appRoleBadge]="usuario.role">{{ usuario.role }}</span>
            <span class="badge estado" [class.ok]="usuario.activo && (usuario.aprobado !== false)"
                                      [class.warning]="!usuario.activo || usuario.aprobado === false">
              <ng-container *ngIf="usuario.role === 'especialista'; else estadoUsuario">
                {{ usuario.aprobado ? 'Aprobado' : 'Pendiente' }}
              </ng-container>
              <ng-template #estadoUsuario>
                {{ usuario.activo ? 'Activo' : 'Inactivo' }}
              </ng-template>
            </span>
          </div>
        </header>

        <section class="datos">
          <div class="dato" *ngIf="usuario.dni">
            <span class="label">DNI</span>
            <span class="valor">{{ usuario.dni }}</span>
          </div>
          <div class="dato" *ngIf="usuario.obraSocial">
            <span class="label">Obra social</span>
            <span class="valor">{{ usuario.obraSocial }}</span>
          </div>
          <div class="dato" *ngIf="usuario.especialidades?.length">
            <span class="label">Especialidades</span>
            <div class="especialidades">
              <span class="chip" *ngFor="let esp of usuario.especialidades">{{ esp }}</span>
            </div>
          </div>
        </section>

        <footer>
          <div class="acciones-secundarias">
            <button *ngIf="usuario.role === 'especialista' && !usuario.aprobado" 
                    class="positivo"
                    (click)="$event.stopPropagation(); aprobarEspecialista(usuario)">
              <i class="pi pi-check-circle"></i>
              Aprobar especialista
            </button>
            <div class="indicador-descarga" *ngIf="usuario.role === 'paciente'">
              <i class="pi pi-download"></i>
              <span>Seleccioná la tarjeta para descargar turnos</span>
            </div>
          </div>
          <div class="acciones-estado">
            <button *ngIf="usuario.activo" class="negativo" (click)="$event.stopPropagation(); deshabilitarUsuario(usuario)">
              <i class="pi pi-user-minus"></i>
              Deshabilitar
            </button>
            <button *ngIf="!usuario.activo" class="positivo" (click)="$event.stopPropagation(); habilitarUsuario(usuario)">
              <i class="pi pi-user-plus"></i>
              Habilitar
            </button>
          </div>
        </footer>
      </article>
    }
  </div>

  <div *ngIf="!cargando() && filtrarUsuarios().length === 0" class="empty-state">
    <i class="pi pi-users"></i>
    <p>No hay usuarios que coincidan con los filtros seleccionados.</p>
  </div>

  <div *ngIf="cargando()" class="loading">
    <div class="spinner"></div>
    <p>Cargando usuarios...</p>
  </div>
</div>
