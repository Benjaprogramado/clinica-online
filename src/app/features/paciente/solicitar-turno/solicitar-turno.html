<div class="solicitar-turno-container">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        <div class="card custom-card">
          <div class="card-header">
            <h2 class="mb-0">
              <i class="pi pi-calendar-plus me-2"></i>
              Solicitar Turno
            </h2>
          </div>

          <div class="card-body">
            <form [formGroup]="formulario" (ngSubmit)="onSubmit()">
              <!-- Especialidad -->
              <div class="mb-4">
                <label class="form-label fw-bold">
                  Especialidad <span class="text-danger">*</span>
                </label>
                <div class="d-flex flex-wrap gap-2">
                  @for (esp of especialidades(); track esp) {
                    <button
                      type="button"
                      class="btn"
                      [class.btn-primary]="formulario.get('especialidad')?.value === esp"
                      [class.btn-outline-primary]="formulario.get('especialidad')?.value !== esp"
                      (click)="formulario.patchValue({ especialidad: esp, especialista: '', fecha: '', hora: '' }); onEspecialidadSeleccionada()">
                      {{ esp }}
                    </button>
                  }
                </div>
                @if (formulario.get('especialidad')?.invalid && formulario.get('especialidad')?.touched) {
                  <div class="text-danger small mt-1">
                    Selecciona una especialidad
                  </div>
                }
              </div>

              <!-- Especialista -->
              @if (formulario.get('especialidad')?.value) {
                <div class="mb-4">
                  <label class="form-label fw-bold">
                    Especialista <span class="text-danger">*</span>
                  </label>
                  <div class="row g-3">
                    @for (esp of especialistas(); track esp.uid) {
                      <div class="col-12 col-md-6">
                        <button
                          type="button"
                          class="btn w-100 text-start p-3 h-100"
                          [class.btn-primary]="formulario.get('especialista')?.value === esp.uid"
                          [class.btn-outline-primary]="formulario.get('especialista')?.value !== esp.uid"
                          (click)="formulario.patchValue({ especialista: esp.uid, fecha: '', hora: '' }); onEspecialistaSeleccionado()">
                          <div class="d-flex align-items-center">
                            @if (esp.imagenPerfil) {
                              <img [src]="esp.imagenPerfil" alt="{{ esp.nombre }}" class="avatar me-3">
                            } @else {
                              <div class="avatar-placeholder me-3">
                                <i class="pi pi-user"></i>
                              </div>
                            }
                            <div>
                              <div class="fw-bold">{{ esp.nombre }} {{ esp.apellido }}</div>
                              <small class="text-muted">{{ esp.email }}</small>
                            </div>
                          </div>
                        </button>
                      </div>
                    }
                  </div>
                  @if (especialistas().length === 0) {
                    <div class="alert alert-warning">
                      No hay especialistas disponibles para esta especialidad.
                    </div>
                  }
                  @if (formulario.get('especialista')?.invalid && formulario.get('especialista')?.touched) {
                    <div class="text-danger small mt-1">
                      Selecciona un especialista
                    </div>
                  }
                </div>
              }

              <!-- Fecha -->
              @if (formulario.get('especialista')?.value) {
                <div class="mb-4">
                  <label class="form-label fw-bold">
                    Fecha <span class="text-danger">*</span>
                  </label>
                  <div class="d-flex flex-wrap gap-2">
                    @for (fecha of fechasDisponibles(); track fecha.getTime()) {
                      <button
                        type="button"
                        class="btn"
                        [class.btn-primary]="formulario.get('fecha')?.value === formatearFechaParaInput(fecha)"
                        [class.btn-outline-primary]="formulario.get('fecha')?.value !== formatearFechaParaInput(fecha)"
                        (click)="seleccionarFecha(fecha)">
                        {{ fecha | date:'dd/MM/yyyy' }}
                      </button>
                    }
                  </div>
                  @if (fechasDisponibles().length === 0) {
                    <div class="alert alert-warning">
                      No hay fechas disponibles.
                    </div>
                  }
                  @if (formulario.get('fecha')?.invalid && formulario.get('fecha')?.touched) {
                    <div class="text-danger small mt-1">
                      Selecciona una fecha
                    </div>
                  }
                </div>
              }

              <!-- Hora -->
              @if (formulario.get('fecha')?.value) {
                <div class="mb-4">
                  <label class="form-label fw-bold">
                    Hora <span class="text-danger">*</span>
                  </label>
                  <div class="d-flex flex-wrap gap-2">
                    @for (hora of horariosDisponibles(); track hora) {
                      <button
                        type="button"
                        class="btn"
                        [class.btn-primary]="formulario.get('hora')?.value === hora"
                        [class.btn-outline-primary]="formulario.get('hora')?.value !== hora"
                        (click)="formulario.patchValue({ hora: hora })">
                        {{ hora }}
                      </button>
                    }
                  </div>
                  @if (horariosDisponibles().length === 0) {
                    <div class="alert alert-warning">
                      No hay horarios disponibles para esta fecha.
                    </div>
                  }
                  @if (formulario.get('hora')?.invalid && formulario.get('hora')?.touched) {
                    <div class="text-danger small mt-1">
                      Selecciona una hora
                    </div>
                  }
                </div>
              }

              <!-- Comentario -->
              <div class="mb-4">
                <label class="form-label fw-bold">Comentario (opcional)</label>
                <textarea
                  class="form-control"
                  formControlName="comentario"
                  rows="3"
                  placeholder="Agrega algÃºn comentario sobre tu consulta..."></textarea>
              </div>

              <!-- Captcha -->
              <div class="mb-4">
                <app-captcha (captchaValidado)="onCaptchaValidado($event)"></app-captcha>
              </div>

              <!-- Botones -->
              <div class="d-flex gap-2 justify-content-end">
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="router.navigate(['/paciente/mis-turnos'])">
                  Cancelar
                </button>
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="formulario.invalid || !captchaValido()">
                  <i class="pi pi-check me-2"></i>
                  Solicitar Turno
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
