<div class="solicitar-turno-container">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">
        <div class="card custom-card">
          <div class="card-header">
            <h2 class="mb-0">
              <i class="pi pi-calendar-plus me-2"></i>
              Solicitar Turno
            </h2>
          </div>

          <div class="card-body">
            <form [formGroup]="formulario" (ngSubmit)="onSubmit()">
              @if (modoAdmin()) {
                <div class="mb-4">
                  <label class="form-label fw-bold">
                    Paciente <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-select"
                    formControlName="paciente">
                    <option value="">Selecciona un paciente registrado</option>
                    @for (pac of pacientes(); track pac.uid) {
                      <option [value]="pac.uid">
                        {{ pac.nombre }} {{ pac.apellido }} - DNI: {{ pac.dni }}
                      </option>
                    }
                  </select>
                  @if (pacientes().length === 0) {
                    <div class="alert alert-warning mt-2">
                      No hay pacientes registrados para asignar turnos.
                    </div>
                  }
                  @if (formulario.get('paciente')?.invalid && formulario.get('paciente')?.touched) {
                    <div class="text-danger small mt-1">
                      Selecciona un paciente
                    </div>
                  }
                </div>
              }

              <!-- Paso 1: Profesionales (botones cuadrados con imagen) -->
              <div class="mb-4">
                <label class="form-label fw-bold">
                  Profesional <span class="text-danger">*</span>
                </label>
                <div class="profesionales-grid">
                  @for (esp of especialistas(); track esp.uid) {
                    <button
                      type="button"
                      class="btn-profesional"
                      [class.btn-profesional-selected]="formulario.get('especialista')?.value === esp.uid"
                      (click)="formulario.patchValue({ especialista: esp.uid, especialidad: '', fechaHora: '' }); onEspecialistaSeleccionado()">
                      <div class="profesional-imagen">
                        @if (esp.imagenPerfil) {
                          <img [src]="esp.imagenPerfil" [alt]="esp.nombre + ' ' + esp.apellido" onerror="this.src='assets/images/default-profesional.png'">
                        } @else {
                          <div class="profesional-placeholder">
                            <i class="pi pi-user"></i>
                          </div>
                        }
                      </div>
                      <div class="profesional-nombre">
                        {{ esp.nombre }} {{ esp.apellido }}
                      </div>
                    </button>
                  }
                </div>
                @if (especialistas().length === 0) {
                  <div class="alert alert-warning">
                    No hay profesionales disponibles.
                  </div>
                }
                @if (formulario.get('especialista')?.invalid && formulario.get('especialista')?.touched) {
                  <div class="text-danger small mt-1">
                    Selecciona un profesional
                  </div>
                }
              </div>

              <!-- Paso 2: Especialidades (botones rectangulares con imagen) -->
              @if (formulario.get('especialista')?.value) {
                <div class="mb-4">
                  <label class="form-label fw-bold">
                    Especialidad <span class="text-danger">*</span>
                  </label>
                  <div class="especialidades-grid">
                    @for (esp of especialidadesDelEspecialista(); track esp) {
                      <div class="especialidad-item">
                        <div class="especialidad-nombre">{{ esp }}</div>
                        <button
                          type="button"
                          class="btn-especialidad"
                          [class.btn-especialidad-selected]="formulario.get('especialidad')?.value === esp"
                          (click)="formulario.patchValue({ especialidad: esp, fechaHora: '' }); onEspecialidadSeleccionada()">
                          <div class="especialidad-imagen">
                            <img [src]="esp | especialidadImagen" [alt]="esp" onerror="this.src='assets/images/especialidades/default.png'">
                          </div>
                        </button>
                      </div>
                    }
                  </div>
                  @if (especialidadesDelEspecialista().length === 0) {
                    <div class="alert alert-warning">
                      Este profesional no tiene especialidades configuradas.
                    </div>
                  }
                  @if (formulario.get('especialidad')?.invalid && formulario.get('especialidad')?.touched) {
                    <div class="text-danger small mt-1">
                      Selecciona una especialidad
                    </div>
                  }
                </div>
              }

              <!-- Paso 3: Turnos disponibles (botones cuadrados con fecha y hora) -->
              @if (formulario.get('especialidad')?.value) {
                <div class="mb-4">
                  <label class="form-label fw-bold">
                    Día y Horario <span class="text-danger">*</span>
                  </label>
                  <div class="turnos-grid">
                    @for (turno of turnosDisponibles(); track turno.fechaHoraStr) {
                      <button
                        type="button"
                        class="btn-turno"
                        [class.btn-turno-selected]="formulario.get('fechaHora')?.value === turno.fechaHoraStr"
                        (click)="formulario.patchValue({ fechaHora: turno.fechaHoraStr })">
                        {{ turno.fechaHoraStr }}
                      </button>
                    }
                  </div>
                  @if (turnosDisponibles().length === 0) {
                    <div class="alert alert-warning">
                      No hay turnos disponibles para esta especialidad.
                    </div>
                  }
                  @if (formulario.get('fechaHora')?.invalid && formulario.get('fechaHora')?.touched) {
                    <div class="text-danger small mt-1">
                      Selecciona un día y horario
                    </div>
                  }
                </div>
              }

              <!-- Comentario -->
              <div class="mb-4">
                <label class="form-label fw-bold">Comentario (opcional)</label>
                <textarea
                  class="form-control"
                  formControlName="comentario"
                  rows="3"
                  placeholder="Agrega algún comentario sobre tu consulta..."></textarea>
              </div>

              <!-- reCAPTCHA -->
              @if (!modoAdmin()) {
                <div class="mb-4">
                  <label class="form-label fw-bold">
                    Verificación de seguridad <span class="text-danger">*</span>
                  </label>
                  <app-recaptcha (captchaValidado)="onCaptchaValidado($event)"></app-recaptcha>
                </div>
              }

              <!-- Botones -->
              <div class="d-flex gap-2 justify-content-end">
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="onCancelar()">
                  Cancelar
                </button>
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="formulario.invalid || !captchaValidado()">
                  <i class="pi pi-check me-2"></i>
                  Solicitar Turno
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
